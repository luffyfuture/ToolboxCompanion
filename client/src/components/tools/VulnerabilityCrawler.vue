<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { ElButton, ElInput, ElTable, ElTableColumn, ElSelect, ElOption, ElMessage } from 'element-plus';
// import { useToast } from '@/hooks/use-toast'; // 假设 useToast 仍然可用或需要替换

interface Vulnerability {
  id: number;
  title: string;
  description: string;
  cveId: string | null;
  severity: string;
  publishedDate: string;
  source: string;
  url: string;
  createdAt: string;
  updatedAt: string;
  userId: number | null;
}

const vulnerabilities = ref<Vulnerability[]>([]);
const searchTerm = ref('');
const selectedSeverity = ref('');
const selectedSource = ref('');
const sources = ref<string[]>([]);
const severities = ref<string[]>([]);
// const { toast } = useToast();

const fetchVulnerabilities = async () => {
  try {
    let url = '/api/vulnerabilities';
    const params = new URLSearchParams();
    if (selectedSeverity.value) {
      params.append('severity', selectedSeverity.value);
    }
    if (selectedSource.value) {
      params.append('source', selectedSource.value);
    }
    if (params.toString()) {
      url += `?${params.toString()}`;
    }
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const data = await response.json();
    vulnerabilities.value = data.map((v: any) => ({
      ...v,
      publishedDate: new Date(v.publishedDate).toLocaleDateString(),
      createdAt: new Date(v.createdAt).toLocaleDateString(),
      updatedAt: new Date(v.updatedAt).toLocaleDateString(),
    }));
  } catch (error) {
    console.error('Error fetching vulnerabilities:', error);
    ElMessage({
      message: '获取漏洞失败：无法加载漏洞数据。',
      type: 'error',
    });
  }
};

const fetchSourcesAndSeverities = async () => {
  try {
    const [sourcesRes, severitiesRes] = await Promise.all([
      fetch('/api/vulnerabilities/sources'),
      fetch('/api/vulnerabilities/severities'),
    ]);

    if (!sourcesRes.ok || !severitiesRes.ok) {
      throw new Error('Failed to fetch sources or severities');
    }

    sources.value = await sourcesRes.json();
    severities.value = await severitiesRes.json();
  } catch (error) {
    console.error('Error fetching sources and severities:', error);
    ElMessage({
      message: '获取筛选条件失败：无法加载漏洞来源和严重性。',
      type: 'error',
    });
  }
};

const searchVulnerabilities = async () => {
  if (!searchTerm.value) {
    fetchVulnerabilities();
    return;
  }
  try {
    const response = await fetch(`/api/vulnerabilities/search?q=${searchTerm.value}`);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const data = await response.json();
    vulnerabilities.value = data.map((v: any) => ({
      ...v,
      publishedDate: new Date(v.publishedDate).toLocaleDateString(),
      createdAt: new Date(v.createdAt).toLocaleDateString(),
      updatedAt: new Date(v.updatedAt).toLocaleDateString(),
    }));
  } catch (error) {
    console.error('Error searching vulnerabilities:', error);
    ElMessage({
      message: '搜索漏洞失败：无法搜索漏洞数据。',
      type: 'error',
    });
  }
};

const crawlVulnerabilities = async (source: string) => {
  try {
    ElMessage({
      message: `正在从 ${source} 抓取漏洞...`,
      type: 'info',
    });
    const response = await fetch('/api/vulnerabilities/crawl', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ source }),
    });
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const result = await response.json();
    ElMessage({
      message: result.message,
      type: 'success',
    });
    fetchVulnerabilities(); // Refresh list after crawling
  } catch (error) {
    console.error('Error crawling vulnerabilities:', error);
    ElMessage({
      message: '漏洞抓取过程中发生错误。',
      type: 'error',
    });
  }
};

const deleteVulnerability = async (id: number) => {
  try {
    const response = await fetch(`/api/vulnerabilities/${id}`, {
      method: 'DELETE',
    });
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    ElMessage({
      message: '漏洞删除成功。',
      type: 'success',
    });
    fetchVulnerabilities(); // Refresh list after deletion
  } catch (error) {
    console.error('Error deleting vulnerability:', error);
    ElMessage({
      message: '删除漏洞失败。',
      type: 'error',
    });
  }
};

onMounted(() => {
  fetchVulnerabilities();
  fetchSourcesAndSeverities();
});
</script>

<template>
  <div class="p-4">
    <h1 class="text-2xl font-bold mb-4">漏洞抓取与管理</h1>

    <div class="flex space-x-4 mb-4">
      <el-button type="primary" @click="crawlVulnerabilities('NVD')">从 NVD 抓取</el-button>
      <el-button type="primary" @click="crawlVulnerabilities('CNNVD')">从 CNNVD 抓取</el-button>
    </div>

    <div class="flex space-x-4 mb-4">
      <el-input
        v-model="searchTerm"
        placeholder="搜索漏洞 (标题, 描述, CVE ID, 来源)"
        class="flex-grow"
        @keyup.enter="searchVulnerabilities"
      />
      <el-button type="primary" @click="searchVulnerabilities">搜索</el-button>
      <el-select v-model="selectedSeverity" placeholder="按严重性筛选" @change="fetchVulnerabilities">
        <el-option label="所有严重性" value=""></el-option>
        <el-option v-for="severity in severities" :key="severity" :label="severity" :value="severity"></el-option>
      </el-select>
      <el-select v-model="selectedSource" placeholder="按来源筛选" @change="fetchVulnerabilities">
        <el-option label="所有来源" value=""></el-option>
        <el-option v-for="source in sources" :key="source" :label="source" :value="source"></el-option>
      </el-select>
      <el-button @click="fetchVulnerabilities">重置筛选</el-button>
    </div>

    <el-table :data="vulnerabilities" style="width: 100%">
      <el-table-column prop="title" label="标题" width="180"></el-table-column>
      <el-table-column prop="description" label="描述" width="250">
        <template #default="{ row }">
          {{ row.description.substring(0, 100) }}...
        </template>
      </el-table-column>
      <el-table-column prop="cveId" label="CVE ID" width="120"></el-table-column>
      <el-table-column prop="severity" label="严重性" width="100"></el-table-column>
      <el-table-column prop="publishedDate" label="发布日期" width="120"></el-table-column>
      <el-table-column prop="source" label="来源" width="100"></el-table-column>
      <el-table-column label="链接" width="80">
        <template #default="{ row }">
          <a :href="row.url" target="_blank" class="text-blue-500 hover:underline">查看</a>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="100">
        <template #default="{ row }">
          <el-button type="danger" size="small" @click="deleteVulnerability(row.id)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>